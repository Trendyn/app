box: athakwani/box-yeoman-plus-gulp@0.6.0
# Build definition
build:
  # The steps that will be executed on build
  steps:
    # A step that executes `npm install` command
    - npm-install
    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
        name: bower install
        code: ./node_modules/bower/bin/bower install
    - script:
        name: gulp build
        code: ./node_modules/gulp/bin/gulp.js build

    - script:
        name: gulp test
        code: ./node_modules/gulp/bin/gulp.js test --production

    - script:
        name: gulp e2e
        code: cd ./dbScripts; ./add_maps.sh opinions; cd ..;  sudo ./node_modules/gulp/bin/gulp.js e2e --production

deploy:
  steps:
    - add-to-known_hosts:
        hostname: $SERVER
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $delhiopinions_PRIVATE
        overwrite: true
        hide-from-log: true
    - script:
        name: Installing node & git on server if not present.
        code: |
          ssh -i $PRIVATEKEY_PATH root@$SERVER "curl -sL https://deb.nodesource.com/setup | bash -; apt-get install nodejs -y; apt-get install npm -y; apt-get install git -y;"
    - script:
        name: Making directory on server if not exists
        code: |
          ssh -i $PRIVATEKEY_PATH root@$SERVER "mkdir -p ~/delhiopinions;"
    - script:
        name: Compressing
        code: |
          tar -cvf build.tar recluster.js server.js lib build dbScripts package.json postinstall.sh run.sh common
    - script:
        name: Transferring
        code: |
          scp -i $PRIVATEKEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=no build.tar root@$SERVER:~/delhiopinions
    - script:
        name: Uncompressing at server
        code: |
          ssh -i $PRIVATEKEY_PATH root@$SERVER "cd ~/delhiopinions; tar -xvf build.tar"
    - script:
        name: Running npm install at server
        code: |
          ssh -i $PRIVATEKEY_PATH root@$SERVER "cd ~/delhiopinions; npm install"
    - script:
        name: (Re)Loading server
        code: |
          ssh -i $PRIVATEKEY_PATH root@$SERVER "cd ~/delhiopinions; sh ./run.sh"
